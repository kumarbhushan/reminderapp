<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  <head>
    <title>My Team</title>
<meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <meta http-equiv="Content-Security-Policy" content="
      default-src * data: gap: https://ssl.gstatic.com 'unsafe-eval';
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      script-src 'self' 'unsafe-inline' 'unsafe-eval' *;
      connect-src 'self' 'unsafe-inline' 'unsafe-eval' blob: ws: *;">
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="resources/scripts/jquery-1.7.1.min.js"></script>
    <script src="resources/scripts/jquery-ui-1.8.10.custom.min.js"></script>
    <script src="cordova.js"></script>
    <script src="cordova_plugins.js"></script>

      
<link rel="stylesheet" href="css/otl.css">
<script>
          function cancelCall(){
         document.getElementById("CallConfirm").style.display="none";
    }
    function call(){
         document.getElementById("CallConfirm").style.display="block";
           
        console.log("call")
    }  
    var db;
    var shortName = 'WebSqlDB';
    var version = '1.0';
    var displayName = 'WebSqlDB';
    var maxSize = 4.9 * 1024 * 1024;
    var contactAdded = 0;
    var ContactName= "";
    var ContactNUmber= "";
    var names=[];
    var numbers={};
    var colorArray = ['#bcbec0', '#be1e2d', '#f15a29', '#1b75bc', '#009444'];
          
          
  document.addEventListener("deviceready", onDeviceReady, false);
          

   function onDeviceReady() {
    var options = new ContactFindOptions();
    options.filter = "";          // empty search string returns all contacts
    options.multiple = true;      // return multiple results
    filter = ["displayName", "name"];   // return contact.displayName 
       
    navigator.contacts.find(filter, onSuccess, onError, options);
       
        StatusBar.hide();
       
       $("#importContactDone").click(function(){
           var planCompleted = localStorage.getItem('planCompleted');
          if(planCompleted == "0" || planCompleted == 0){
                document.location.href='CreateMySafetyPlanQ4.html'; 
             }
             else{
                 if (localStorage.getItem("editPlanMode")=="on"){
                     document.location.href='MySafetyPlan.html';
                 }
                 else{
                   document.location.href='myteam.html';  
                 }
                 
             } 
       });
            
}



    function errorHandler(transaction, error) {
               console.log('Error: ' + error.message + ' code: ' + error.code);
          }

    function successCallBack() {
               console.log("DEBUGGING: success");
    }

    function nullHandler(){};

    function createTable(){


         if (!window.openDatabase) {

           console.log('Databases are not supported in this browser.');
           return;
        }
        db = openDatabase(shortName, version, displayName,maxSize);
         db.transaction(function(tx){
           tx.executeSql( 'CREATE TABLE IF NOT EXISTS Contacts(UId INTEGER NOT NULL PRIMARY KEY, ContactName TEXT NOT NULL, ContactNumber TEXT NOT NULL, ContactColor TEXT NOT NULL)', [], nullHandler,errorHandler); },errorHandler,successCallBack);
        }

          
          
    function AddValueToDB(ContactName, ContactNumber) {
        var ContactColor =  colorArray[Math.floor(Math.random() * colorArray.length)];
         if (!window.openDatabase) {
           console.log('Databases are not supported in this browser.');
           return;
         }
          db.transaction(function(transaction) {
                    transaction.executeSql('INSERT INTO Contacts(ContactName, ContactNumber, ContactColor) VALUES (?,?, ?)', [ContactName, ContactNumber, ContactColor], nullHandler,errorHandler, successCallBack);
          },errorHandler,successCallBack);

            var contactFull = (ContactName + ContactNumber).replace(/\s+/, "") ;
            contactFull = contactFull.replace(/[\W_]+/g,"");
                     console.log(contactFull);
                     $("#add"+contactFull).hide();
        }

    function GetValueFromDB() {
          contactAdded = 0;
         if (!window.openDatabase) {
           console.log('Databases are not supported in this browser.');
           return;
         }             
          db.transaction(function(transaction) {
         transaction.executeSql('SELECT ContactName, ContactNumber FROM Contacts',[], function(transaction,results){

         if (results.rows.length){
             console.log(results);
             for (i=0; i<results.rows.length; i++){
                  var contactFull = (results.rows.item(i).ContactName +results.rows.item(i).ContactNumber).replace(/\s+/, "");
                contactFull = contactFull.replace(/[\W_]+/g,"");
                 console.log(contactFull);
                 $("#add"+contactFull).hide();
             }
         }
        else {
                contactAdded = 0;
        }                   
         });
        });
    }

    function onSuccess(contacts) {
        createTable();
        GetValueFromDB();
       for (var i = 0; i < contacts.length; i++) {

               if (contacts[i].name) {  // many contacts don't have displayName
                   var fullname = contacts[i].name.formatted;
                names.push(fullname);
                   if(contacts[i].phoneNumbers != null && contacts[i].phoneNumbers != ''){
                       var phoneNumList = [];
                       for (var j = 0; j <1 ; j++){ //contacts[i].phoneNumbers.length is replaced with 1 to avoid duplication
                           if((phoneNumList.includes(contacts[i].phoneNumbers[j].value) == false)){
                              phoneNumList.push(contacts[i].phoneNumbers[0].value);
                              }
                       }        
                       numbers[contacts[i].name.formatted]=phoneNumList;
                   }
            }
        }
        var orderedNumbers = {};
          Object.keys(numbers)
          .sort()
          .forEach(function(k, v) {
              if(k!=undefined && k!="undefined"){
                 orderedNumbers[k] = numbers[k]; 
              }
           });
        console.log(orderedNumbers);
            for (var key in orderedNumbers){
                var elementId = "";
                 elementId = (key+orderedNumbers[key]).replace(/\s+/, "") ;
                          var elementId2=elementId.replace(/[\W_]+/g,"");

                 $("#contactsList").append('<div><div class="'+'contactList"'+'><div value="'+key+'" class="'+'contactName inline"'+'>' + key + '</div>' +'<div hidden value="'+orderedNumbers[key]+'" class="'+'contactNum inline "'+'>' + orderedNumbers[key] +'</div><div id="add'+elementId2+'" class="'+'inline addContactBtn"></div></div></div>');
            }
            

            
            
            
        $(".addContactBtn").click(function() {

             var ContactName = $(this).prev().prev()[0].innerText.trim();
            var ContactNumber = $(this).prev()[0].innerText.trim();
            AddValueToDB(ContactName, ContactNumber);
            console.log($(this).prev().prev()[0].innerText);
            console.log($(this).prev()[0].innerText);
            //$(this).hide();

        });
}

function onError(contactError) {
     console.log('onError!');
    var planCompleted = localStorage.getItem('planCompleted');
          if(planCompleted == "0" || planCompleted == 0){
                document.location.href='CreateMySafetyPlan4.html'; 
             }
             else{
                 document.location.href='myteam.html';
             } 
}



</script>


  </head>
  <body class="white">
      <!-- top & bottom gradient -->
      <div class="grad-top"></div>
      <div class="grad-bot"></div>
      
      <!-- panel overlays -->
      <div class="top-overlay">
          <!-- section title -->
          <div class="sectionbar">
              <div class="section-title info">
                  <div class="section-icon-myteam"></div>My Team</div>
          </div>
       
       <div class="titlebar">
              <div class="title">Import Contacts</div>
              
          </div>
      
      </div>
       <div id="CallConfirm" hidden >
          <h4>Are you sure you want to dial 000?</h4>
           <div class="btncall-btns">
         <a href="tel:000" ><div class="btn-call-yes" id="btn-call-yes">Yes</div></a>
           <div class="btn-call-no" id="btn-call-no" onclick="cancelCall()">No</div>
         </div>
      </div>
      <div class="bot-overlay-high"></div>
      
      <!-- top navigation -->
      <div class="topnav-container">
          <div class="topnav">
              <a href="info.html" class="btn-info"></a>
              <a href="emergencylist.html" class="btn-emergencylist"></a>
              <a href="#" class="btn-000rib"><a onClick="call();" class="btn-000num">000</a></a>
          </div>
      </div>
      <div id="ContactsAddPage" hidden>
          <h4>Add</h4>
          <a href="contacts.html"><div class="btn-phone-contacts" id="btn-camera">New From Phone</div></a>
          <a href="addcontacts.html"><div class="btn-add-contacts" id="btn-library">New Contact</div></a>
          <img hidden id="myImage" style="width:50px; height:50px;"/>
          <!--<div class="btn-save" onclick="saveImage();">Save</div>-->
      </div>
       <div class="bot-container">  <button class="btn-done" id="importContactDone">Done</button></div>
      <!-- bottom navigation -->
      
      <div class="botnav-container">
          <div class="botnav">
              <ul>
                  <li><a href="home.html" class="btntext"><div class="btn"><div class="icon-home"></div></div>Home</a></li>
                  <li><a href="MySafetyPlan.html" class="btntext"><div class="btn"><div class="icon-safetyplan"></div></div>Safety Plan</a></li>
                  <li><a href="MyStuff.html" class="btntext"><div class="btn"><div class=" icon-mystuff"></div></div>My Stuff</a></li>
                  <li><a href="myteam.html" class="btntext-active"><div class="btn-active"><div class="icon-myteam"></div></div>My Team</a></li>
                  <li><a href="tweets.html" class="btntext"><div class="btn"><div class="icon-tweets"></div></div>Tweets</a></li>
              </ul>
          </div>
      </div>
      
      <!-- CONTENT -->
      <div class="grid-container-whitebg">
          
          <div class="margin-top-180p"></div>
          
          <div id="contactsList" style="background-color: #fff">
             
              
</div>
          
          
          
          <div class="margin-bot-170p"></div>
      
    </div>
   
  </body>
</html>
